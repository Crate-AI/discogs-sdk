import e from"isomorphic-unfetch";import{createInterface as t}from"readline";function o(){return o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var s in o)Object.prototype.hasOwnProperty.call(o,s)&&(e[s]=o[s])}return e},o.apply(this,arguments)}class s{generateNonce(){return Date.now().toString()+Math.random().toString().substring(2)}constructor(e){this.DiscogsConsumerKey=void 0,this.DiscogsConsumerSecret=void 0,this.baseUrl=void 0,this.callbackUrl=void 0,this.userAgent=void 0,this.DiscogsConsumerKey=e.DiscogsConsumerKey,this.DiscogsConsumerSecret=e.DiscogsConsumerSecret,this.baseUrl=e.baseUrl||"https://api.discogs.com",this.callbackUrl=e.callbackUrl||"http://localhost:3000/callback",this.userAgent=e.userAgent||"DefaultUserAgent/1.0"}get consumerKey(){return this.DiscogsConsumerKey}get consumerSecret(){return this.DiscogsConsumerSecret}get callbackUrlGetter(){return this.callbackUrl}get baseUrlGetter(){return this.baseUrl}get userAgentGetter(){return this.userAgent}get nonceGetter(){return this.generateNonce()}generateOAuthHeader(){const e=Date.now().toString(),t=this.generateNonce();return`OAuth oauth_consumer_key="${this.DiscogsConsumerKey}",oauth_signature_method="PLAINTEXT",oauth_timestamp="${e}",oauth_nonce="${t}",oauth_version="1.0",oauth_signature="${this.DiscogsConsumerSecret}&"`}async request(t,s,r){const n=`${this.baseUrl}${t.startsWith("/")?"":"/"}${t}`,a=new Headers({Authorization:this.generateOAuthHeader(),"User-Agent":this.userAgent});r&&"string"==typeof r?a.set("Content-Type","application/x-www-form-urlencoded"):r&&(a.set("Content-Type","application/json"),r=JSON.stringify(r));const i=o({headers:a},s,{body:r,method:(null==s?void 0:s.method)||"GET"}),c=await e(n,i);if(!c.ok){const e=await c.text();throw new Error(`HTTP error ${c.status}: ${e}`)}const u=c.headers.get("Content-Type")||"";if(u.includes("application/json"))return c.json();if(u.includes("application/x-www-form-urlencoded")){const e=await c.text();return new URLSearchParams(e)}throw new Error(`Unsupported content type: ${u}`)}}class r{static setItem(e,t){r.storage[e]=t}static getItem(e){return r.storage[e]}}r.storage={};class n extends s{}var a;a=n,[class extends s{generateTimestamp(){return`${Date.now()}`}createVerificationURL(e){return`https://www.discogs.com/oauth/authorize?oauth_token=${e}`}async getRequestToken(){const e=this.generateTimestamp(),t=new URLSearchParams({oauth_callback:this.callbackUrlGetter,oauth_consumer_key:this.consumerKey,oauth_nonce:this.nonceGetter,oauth_signature_method:"PLAINTEXT",oauth_timestamp:e,oauth_version:"1.0"}).toString(),o=await this.request("oauth/request_token",{method:"POST"},t);return{oauthRequestToken:o.get("oauth_token"),oauthRequestTokenSecret:o.get("oauth_token_secret"),verificationURL:this.createVerificationURL(o.get("oauth_token"))}}async getAccessToken(e){const t=this.generateTimestamp(),o=this.nonceGetter,s=new URLSearchParams({oauth_token:e.oauthToken,oauth_verifier:e.oauthVerifier}).toString(),r={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:`OAuth oauth_consumer_key="${this.consumerKey}",oauth_signature_method="PLAINTEXT",oauth_timestamp="${t}",oauth_nonce="${o}",oauth_version="1.0",oauth_token="${e.oauthToken}",oauth_verifier="${e.oauthVerifier}",oauth_signature="${this.consumerSecret}&${e.tokenSecret}"`,"User-Agent":this.userAgentGetter}},n=await this.request("oauth/access_token",r,s);return{oauthAccessToken:n.get("oauth_token"),oauthAccessTokenSecret:n.get("oauth_token_secret")}}async getUserIdentity(e){const t={"Content-Type":"application/x-www-form-urlencoded",Authorization:`OAuth oauth_consumer_key="${this.consumerKey}",oauth_token="${e.oauthToken}",oauth_signature_method="PLAINTEXT",oauth_timestamp="${Date.now().toString()}",oauth_nonce="${this.nonceGetter}",oauth_signature="${this.consumerSecret}&${e.oauthTokenSecret}"`,"User-Agent":this.userAgentGetter};return this.request("oauth/identity",{method:"GET",headers:t})}async authenticateAndGetIdentity(){try{const e=await this.getRequestToken();console.log(`Please visit this URL to authorize the application: ${e.verificationURL}`);const o=t({input:process.stdin,output:process.stdout}),s=await new Promise(e=>{o.question("Please enter the OAuth verifier: ",t=>{o.close(),e(t)})}),n=await this.getAccessToken({oauthToken:e.oauthRequestToken,tokenSecret:e.oauthRequestTokenSecret,oauthVerifier:s});r.setItem("oauthAccessToken",n.oauthAccessToken),r.setItem("oauthAccessTokenSecret",n.oauthAccessTokenSecret);const a=await this.getUserIdentity({oauthToken:n.oauthAccessToken,oauthTokenSecret:n.oauthAccessTokenSecret});return r.setItem("userIdentity",a),a}catch(e){throw console.error("Authentication flow failed:",e),e}}},class extends s{generateTimestamp2(){return`${Date.now()}`}async getCollection(e,t=0,o=1,s=50){const n=r.getItem("oauthAccessToken"),a=r.getItem("oauthAccessTokenSecret"),i=`users/${e}/collection/folders/${t}/releases`,c=new URLSearchParams({page:o.toString(),per_page:s.toString()}).toString(),u={Authorization:`OAuth oauth_consumer_key="${this.consumerKey}",oauth_token="${n}",oauth_signature_method="PLAINTEXT",oauth_timestamp="${this.generateTimestamp2()}",oauth_nonce="${this.nonceGetter}",oauth_signature="${this.consumerSecret}&${a}"`,"User-Agent":this.userAgentGetter};return this.request(`${i}?${c}`,{method:"GET",headers:u})}}].forEach(e=>{Object.getOwnPropertyNames(e.prototype).forEach(t=>{Object.defineProperty(a.prototype,t,Object.getOwnPropertyDescriptor(e.prototype,t))})});export{n as default};
